<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ğŸ² Mini Game à¸«à¸¥à¸±à¸à¸à¸²à¸£à¸™à¸±à¸š Multiplayer</title>
<style>
body {
  background-color: #000;
  color: #fff;
  font-family: 'Arial', sans-serif;
  text-align: center;
  margin:0;
  padding:0;
}
h1 { font-weight: bold; margin: 15px 0; font-size: 2.2em; }
.question { font-size: 26px; font-weight: bold; margin: 20px 0; }
.answers { display: flex; flex-direction: column; align-items: center; gap: 12px; margin-bottom: 20px; }
.answer-btn {
  background-color: #222; 
  color: #fff; 
  font-weight: bold; 
  padding: 12px 25px; 
  border: 2px solid #fff; 
  border-radius: 12px;
  cursor: pointer;
  width: 280px;
  transition: all 0.2s;
}
.answer-btn:hover { background-color: #444; transform: scale(1.05); }
.players { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
.player { border: 2px solid #fff; border-radius: 10px; padding: 10px; width: 150px; background-color:#111; }
.timer { font-size: 20px; font-weight: bold; margin: 10px 0; }
#roomControls { margin: 20px auto; max-width: 450px; padding:20px; border:2px solid #fff; border-radius:15px; background-color:#111; }
input, select, button { padding: 10px; margin: 5px; border-radius: 10px; font-size:16px; }
#roomInfo { margin-top: 15px; font-weight:bold; font-size:16px; }
.emoji { font-size: 1.2em; margin-left:5px;}
</style>
</head>
<body>

<h1>ğŸ² Mini Game à¸«à¸¥à¸±à¸à¸à¸²à¸£à¸™à¸±à¸š Multiplayer</h1>

<div id="roomControls">
  <h2 style="font-weight:bold; margin-bottom:15px;">ğŸ‘‹ à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸‚à¸­à¸‡à¸„à¸¸à¸“</h2>

  <input id="playerName" placeholder="âœ¨ à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™" style="width:90%; text-align:center;"><br>

  <label for="maxPlayers" style="font-weight:bold;">à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸™à¸«à¹‰à¸­à¸‡:</label>
  <select id="maxPlayers" style="width:50%; text-align:center;">
    <option value="2">2 à¸„à¸™</option>
    <option value="3">3 à¸„à¸™</option>
    <option value="4">4 à¸„à¸™</option>
    <option value="5">5 à¸„à¸™</option>
  </select><br>

  <button onclick="createRoom()" style="width:80%; background-color:#ff5722; color:#fff;">âœ¨ à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ</button><br>
  <input id="roomIdInput" placeholder="ğŸ”‘ à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡"><br>
  <button onclick="joinRoom()" style="width:80%; background-color:#03a9f4; color:#fff;">ğŸš€ à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡</button>

  <div id="roomInfo"></div>
</div>

<div class="question" id="question">à¸£à¸­à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡...</div>

<div class="answers" id="answers"></div>

<div class="timer" id="timer">à¹€à¸§à¸¥à¸²: 30 à¸§à¸´à¸™à¸²à¸—à¸µ â°</div>

<div class="players" id="players"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, push } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

// ---------- Firebase Config ----------
const firebaseConfig = {
  apiKey: "AIzaSyAScwLSlNF1i0cAAT-xadJTFOgGUEsIilk",
  authDomain: "count-raid-game.firebaseapp.com",
  databaseURL: "https://count-raid-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "count-raid-game",
  storageBucket: "count-raid-game.appspot.com",
  messagingSenderId: "887793946867",
  appId: "1:887793946867:web:14c0c60399fcefc8612786"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---------- à¸•à¸±à¸§à¹à¸›à¸£à¹€à¸à¸¡ ----------
let roomId = "";
let playerName = "";
let timeLeft = 30;
let timerInterval;
let currentQuestionIndex = 0;

// ---------- à¸„à¸³à¸–à¸²à¸¡à¸«à¸¥à¸±à¸à¸à¸²à¸£à¸™à¸±à¸š ----------
const questions = [
  {q:"à¸¡à¸µà¸§à¸´à¸˜à¸µà¸ˆà¸±à¸”à¹€à¸£à¸µà¸¢à¸‡à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£ 3 à¸•à¸±à¸§ A,B,C à¸à¸µà¹ˆà¸§à¸´à¸˜à¸µ?", a:["3","6","9","12"], correct:1, bonus:5},
  {q:"à¸–à¹‰à¸²à¹‚à¸¢à¸™à¹€à¸«à¸£à¸µà¸¢à¸ 2 à¹€à¸«à¸£à¸µà¸¢à¸ à¸ˆà¸°à¸¡à¸µà¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸à¸µà¹ˆà¹à¸šà¸š?", a:["2","3","4","5"], correct:2, bonus:3},
  {q:"à¹€à¸¥à¸·à¸­à¸à¸•à¸±à¸§à¹€à¸¥à¸‚ 2 à¸•à¸±à¸§à¸ˆà¸²à¸ 1,2,3,4 à¸ˆà¸°à¹„à¸”à¹‰à¸Šà¸¸à¸”à¸•à¹ˆà¸²à¸‡ à¹† à¸à¸µà¹ˆà¸Šà¸¸à¸”?", a:["4","6","8","12"], correct:1, bonus:4},
];

// ---------- à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡ ----------
function createRoom(){
  playerName = document.getElementById('playerName').value.trim();
  if(!playerName){ alert("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™!"); return; }
  const maxPlayers = parseInt(document.getElementById('maxPlayers').value);

  const roomRef = push(ref(db,'rooms'));
  roomId = roomRef.key;

  set(roomRef,{
    host:playerName,
    maxPlayers:maxPlayers,
    status:"waiting",
    questionIndex:0,
    players:{ [playerName]: {score:0} }
  }).then(()=>{
    const roomInfoDiv = document.getElementById('roomInfo');
    roomInfoDiv.innerHTML = `
      ğŸ‰ à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!<br>
      ğŸ”‘ à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“: <strong>${roomId}</strong><br>
      à¸ªà¹ˆà¸‡à¸£à¸«à¸±à¸ªà¸™à¸µà¹‰à¹ƒà¸«à¹‰à¹€à¸à¸·à¹ˆà¸­à¸™à¹€à¸à¸·à¹ˆà¸­à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡!
    `;
    listenRoom();
  }).catch(err=>alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: "+err.message));
}

// ---------- à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡ ----------
function joinRoom(){
  playerName = document.getElementById('playerName').value.trim();
  roomId = document.getElementById('roomIdInput').value.trim();
  if(!playerName || !roomId){ alert("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¹à¸¥à¸°à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡!"); return; }

  const playerRef = ref(db, `rooms/${roomId}/players/${playerName}`);
  set(playerRef, {score:0}).then(()=>{
    const roomInfoDiv = document.getElementById('roomInfo');
    roomInfoDiv.innerHTML = `
      ğŸš€ à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!<br>
      à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡: <strong>${roomId}</strong>
    `;
    listenRoom();
  }).catch(err=>alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: "+err.message));
}

// ---------- à¸Ÿà¸±à¸‡à¸«à¹‰à¸­à¸‡ ----------
function listenRoom(){
  const roomRef = ref(db, `rooms/${roomId}`);
  onValue(roomRef, snapshot=>{
    const roomData = snapshot.val();
    if(!roomData) return;
    updatePlayers(roomData.players);
    currentQuestionIndex = roomData.questionIndex || 0;

    if(roomData.status==="waiting" && Object.keys(roomData.players).length === roomData.maxPlayers){
      set(ref(db, `rooms/${roomId}/status`),"playing");
    }

    if(roomData.status==="playing"){
      showQuestion();
    }
  });
}

// ---------- à¹à¸ªà¸”à¸‡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ ----------
function updatePlayers(playersObj){
  const playersDiv = document.getElementById('players');
  playersDiv.innerHTML="";
  for(const name in playersObj){
    const div = document.createElement('div');
    div.className="player";
    div.innerHTML=`<strong>${name}</strong> <span class="emoji">â­</span><br>à¸„à¸°à¹à¸™à¸™: ${playersObj[name].score}`;
    playersDiv.appendChild(div);
  }
}

// ---------- à¹à¸ªà¸”à¸‡à¸„à¸³à¸–à¸²à¸¡ ----------
function showQuestion(){
  if(currentQuestionIndex>=questions.length) return;
  clearInterval(timerInterval);
  timeLeft = 30;

  const q = questions[currentQuestionIndex];
  document.getElementById('question').innerText = `â“ ${q.q}`;
  const answersDiv = document.getElementById('answers');
  answersDiv.innerHTML="";
  q.a.forEach((ans,index)=>{
    const btn=document.createElement('button');
    btn.className="answer-btn";
    btn.innerText = ans;
    btn.onclick = ()=> selectAnswer(index);
    answersDiv.appendChild(btn);
  });

  timerInterval=setInterval(()=>{
    timeLeft--;
    document.getElementById('timer').innerText=`à¹€à¸§à¸¥à¸²: ${timeLeft} à¸§à¸´à¸™à¸²à¸—à¸µ â°`;
    if(timeLeft<=0){
      clearInterval(timerInterval);
      alert(`à¸«à¸¡à¸”à¹€à¸§à¸¥à¸²! à¹€à¸‰à¸¥à¸¢à¸„à¸·à¸­: ${q.a[q.correct]} âœ…`);
      nextQuestion();
    }
  },1000);
}

// ---------- à¹€à¸¥à¸·à¸­à¸à¸„à¸³à¸•à¸­à¸š ----------
function selectAnswer(index){
  const q=questions[currentQuestionIndex];
  const playerRef = ref(db, `rooms/${roomId}/players/${playerName}/score`);
  get(playerRef).then(snap=>{
    let score = snap.val()||0;
    if(index===q.correct){
      score += 10+q.bonus;
      alert(`à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡! ğŸ‰ à¹„à¸”à¹‰à¸„à¸°à¹à¸™à¸™à¸à¸´à¹€à¸¨à¸© ${q.bonus}`);
    } else {
      score -=5;
      alert("à¸œà¸´à¸”! âŒ à¸„à¸°à¹à¸™à¸™ -5");
    }
    set(playerRef,score);

    // à¹à¸¢à¹ˆà¸‡à¸„à¸°à¹à¸™à¸™à¹€à¸à¸·à¹ˆà¸­à¸™
    const playersRef = ref(db, `rooms/${roomId}/players`);
    get(playersRef).then(psnap=>{
      const playersData = psnap.val();
      const others = Object.keys(playersData).filter(p=>p!==playerName);
      if(others.length>0){
        const steal = others[Math.floor(Math.random()*others.length)];
        const stealRef = ref(db, `rooms/${roomId}/players/${steal}/score`);
        get(stealRef).then(ssnap=>{
          let sScore = ssnap.val()||0;
          sScore = Math.max(0, sScore-3);
          set(stealRef,sScore);
          set(playerRef,score+3);
          alert(`à¸„à¸¸à¸“à¹à¸¢à¹ˆà¸‡à¸„à¸°à¹à¸™à¸™à¹€à¸à¸·à¹ˆà¸­à¸™ ${steal} à¹„à¸”à¹‰ 3 à¸„à¸°à¹à¸™à¸™ ğŸ’°`);
          nextQuestion();
        });
      } else { nextQuestion(); }
    });
  });
}

// ---------- à¸•à¹ˆà¸­à¸„à¸³à¸–à¸²à¸¡ ----------
function nextQuestion(){
  currentQuestionIndex++;
  set(ref(db, `rooms/${roomId}/questionIndex`),currentQuestionIndex);
  if(currentQuestionIndex>=questions.length){
    alert("à¸ˆà¸šà¹€à¸à¸¡! ğŸ‰");
  } else { showQuestion(); }
}
</script>

</body>
</html>
